{% extends "shop/basic.html" %} {% block title %} Checkout {% endblock %}
{%block body %}

<div class="container my-2">
  <div class="col">
    <h2>Step 1 - My Awesome Cart Express Checkout - Review Your Cart items</h2>

    <div>
      <ol class="list-group list-group-numbered" id="items"></ol>

      <div id="totalBillContainer" class="mt-3 p-3 bg-light border rounded">
        <h4 class="mb-0">
          Total Amount: <span id="grandTotal">Rs. 0.00₹</span>
        </h4>
      </div>
    </div>
  </div>

  <hr />

  <div class="col mt-4">
    <h2>Step 2 - Enter Address & Other Details:</h2>

    <form method="post" action="/shop/checkout/" class="row g-3">
      {% csrf_token %}

      <input type="hidden" id="itemjson" name="itemjson" />
      <input type="hidden" id="amount" name="amount" />

      <div class="col-md-6">
        <label for="name" class="form-label">Name</label>
        <input
          type="name"
          name="name"
          class="form-control"
          id="name"
          placeholder="Name"
        />
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label">Email</label>
        <input
          type="email"
          name="email"
          class="form-control"
          id="email"
          placeholder="Email"
        />
      </div>

      <div class="col-12">
        <label for="address1" class="form-label">Address</label>
        <input
          type="text"
          name="address1"
          class="form-control"
          id="address1"
          placeholder="1234 Main St"
        />
      </div>

      <div class="col-12">
        <label for="address2" class="form-label">Address Line 2</label>
        <input
          type="text"
          name="address2"
          class="form-control"
          id="address2"
          placeholder="Apartment, studio, or floor"
        />
      </div>

      <div class="col-md-6">
        <label for="city" class="form-label">City</label>
        <input type="text" class="form-control" id="city" name="city" />
      </div>

      <div class="col-md-4">
        <label for="state" class="form-label">State</label>
        <input
          type="text"
          name="state"
          class="form-control"
          id="state"
          placeholder="Enter State"
        />
      </div>

      <div class="col-md-2">
        <label for="zip_code" class="form-label">Zip</label>
        <input type="text" class="form-control" id="zip_code" name="zip_code" />
      </div>

      <div class="col-md-6">
        <label for="phone" class="form-label">Phone Number</label>
        <input
          type="tel"
          name="phone"
          class="form-control"
          id="phone"
          placeholder="Enter Phone Number"
        />
      </div>

      <div class="col-12">
        <div class="alert alert-info" role="alert">
          Total Payable Amount:
          <strong id="finalTotalDisplay">Rs. 0.00₹</strong>
        </div>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-success btn-lg">
          Place Order
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  let cart = {};
  let totalItems = 0;
  let grandTotal = 0;

  if (localStorage.getItem("cart") !== null) {
      cart = JSON.parse(localStorage.getItem("cart"));
  }

  $("#items").empty();

  for (let item_id in cart) {
      let item = cart[item_id];
      let name = item.name;
      let qty = item.qty;
      let price = item.price || 0;

      let itemSubtotal = qty * price;

      if (qty > 0) {
          totalItems += qty;
          grandTotal += itemSubtotal;

          let subtotalFormatted = itemSubtotal.toFixed(2);
          let priceFormatted = price.toFixed(2);

          let mystr = `
          <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="ms-2 me-auto">
                  <div>
                      <strong>${name}</strong>
                  </div>
                  <small class="text-muted">
                      Qty:${qty} x Rs.${priceFormatted}₹ =
                      <strong>Rs. ${subtotalFormatted}₹</strong>
                  </small>
              </div>
              <span class="badge text-bg-primary rounded-pill">${qty} Qty</span>
          </li>`;

          $("#items").append(mystr);
      }
  }

  let grandTotalFormatted = grandTotal.toFixed(2);
  $("#grandTotal").text(`Rs. ${grandTotalFormatted}₹`);
  $("#finalTotalDisplay").text(`Rs. ${grandTotalFormatted}₹`);

  document.getElementById("cart").innerHTML = totalItems;
  $("#itemjson").val(JSON.stringify(cart));

  document.querySelector("form").addEventListener("submit", function () {
      document.getElementById("itemjson").value = JSON.stringify(cart);
  });

  {% if thank %}
      alert("Thanks for ordering with us. Your order is {{id}}. Use it to track your order using our order tracker");
      localStorage.clear();
      document.location = "/shop";
  {% endif %}
$('#amount').val(grandTotalFormatted);
</script>
{% endblock %}
