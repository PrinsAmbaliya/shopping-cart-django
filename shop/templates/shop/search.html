{% extends "shop/basic.html" %} {% block title %} MyAwesomeCart - Best Ecommerce
WebSite{% endblock %} {% block body %} {% load static %}
<div class="container my-3">
  <style>
    .carousel-indicators [data-bs-target],
    .carousel-indicators .active {
      background-color: blue;
    }
    .carousel-control-prev,
    .carousel-control-next {
      width: 5%;
      top: 50%;
      transform: translateY(-50%);
    }
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      padding: 10px;
    }
    .product-card-img {
      height: 220px;
      object-fit: cover;
      object-position: top;
      width: 100%;
    }
    .carousel-indicators {
      bottom: 0;
      margin-bottom: -1rem;
    }
    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .text-truncate-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .popover {
      max-width: 350px !important;
    }
  </style>

  {% for product, range, nSlides in allProds %}
  <h5 class="mt-3">{{ product.0.category }}</h5>

  <div
    id="demo{{ forloop.counter }}"
    class="carousel slide"
    data-bs-ride="carousel"
  >
    <div class="carousel-indicators">
      <button
        type="button"
        data-bs-target="#demo{{ forloop.counter }}"
        data-bs-slide-to="0"
        class="active"
      ></button>
      {% for i in range %}
      <button
        type="button"
        data-bs-target="#demo{{ forloop.parentloop.counter }}"
        data-bs-slide-to="{{ i }}"
      ></button>
      {% endfor %}
    </div>

    <div class="carousel-inner">
      <div class="carousel-item active">
        <div class="row">
          {% for i in product %}
          <div class="col-md-3">
            <div class="card" style="width: 18rem">
              <img
                src="/media/{{ i.image }}"
                class="product-card-img"
                style="height: 250px"
              />
              <div class="card-body">
                <h5 class="card-title text-truncate-1" id="name{{i.id}}">
                  {{ i.product_name }}
                </h5>
                <h5 class="card-title text-truncate-1" id="price{{i.id}}">
                  Rs.{{ i.price }}₹
                </h5>
                <p class="card-text text-truncate-3">{{ i.desc }}</p>
                <span id="divpr{{i.id}}" class="divpr">
                  <button data-id="{{ i.id }}" class="btn btn-primary cart">
                    Add To Cart
                  </button>
                </span>
                <a href="/shop/products/{{i.id}}">
                  <button class="btn btn-primary">Quick View</button>
                </a>
              </div>
            </div>
          </div>

          {% if forloop.counter|divisibleby:4 and not forloop.last %}
        </div>
      </div>
      <div class="carousel-item">
        <div class="row">{% endif %} {% endfor %}</div>
      </div>
    </div>

    <button
      class="carousel-control-prev"
      type="button"
      data-bs-target="#demo{{ forloop.counter }}"
      data-bs-slide="prev"
    >
      <span class="carousel-control-prev-icon"></span>
    </button>

    <button
      class="carousel-control-next"
      type="button"
      data-bs-target="#demo{{ forloop.counter }}"
      data-bs-slide="next"
    >
      <span class="carousel-control-next-icon"></span>
    </button>
  </div>
  {% endfor %}
</div>

{% endblock %} {% block js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
{% if msg|length > 0 %}
  alert("{{ msg }}");
  window.location.href = "/";
{% endif %}
  let cart = localStorage.getItem("cart")
    ? JSON.parse(localStorage.getItem("cart"))
    : {};
  const popTrigger = document.getElementById("popcart");
  const pop = new bootstrap.Popover(popTrigger, {
    html: true,
    trigger: "click",
    placement: "bottom",    
    content: "Your cart is empty",
  });

  document.addEventListener("click", function (e) {
    if (e.target.closest(".popover")) e.stopPropagation();
  });

  function updatePopover(cart) {
    let popStr = "<div class='my-2'><h5>Your Shopping Cart</h5>";
    let i = 1;
    let cartEmpty = true;
    let totalAmount = 0;

    for (let item in cart) {
      const quantity = cart[item].qty || 0;
      const name = cart[item].name || "Unknown Product";
      const price = cart[item].price || 0;

      if (quantity > 0) {
        cartEmpty = false;
        totalAmount += quantity * price;

        popStr += `<b>${i}</b>. ${name.slice(0, 15)}${
          name.length > 15 ? "..." : ""
        } Qty: ${quantity}<br>`;
        i++;
      }
    }

    {
      popStr += `<hr><p class='text-start'><strong>Total: Rs. ${totalAmount.toFixed(
        2
      )}₹</strong></p>
        </div>
        <a href="/shop/checkout" class="btn btn-primary btn-sm">Checkout</a>
        <a href="javascript:void(0)" class="btn btn-danger btn-sm" id="clearCartBtn">Clear Cart</a>
        `;
    }
    pop.setContent({ ".popover-body": popStr });
  }

  function updateCart(cart) {
    let total = 0;

    document.querySelectorAll(".divpr").forEach((div) => {
      let productId;
      let initialButton = div.querySelector("button.cart[data-id]");
      let plusButton = div.querySelector("button.plus");

      if (initialButton) productId = initialButton.getAttribute("data-id");
      else if (plusButton) productId = plusButton.id.replace("plus", "");

      if (productId) {
        const quantity = cart[productId] ? cart[productId].qty : 0;
        if (quantity > 0) {
          total += quantity;
          div.innerHTML = `
            <button id="minus${productId}" class="btn btn-primary minus">-</button>
            <span id="val${productId}">${quantity}</span>
            <button id="plus${productId}" class="btn btn-primary plus">+</button>`;
        } else {
          delete cart[productId];
          div.innerHTML = `<button data-id="${productId}" class="btn btn-primary cart">Add To Cart</button>`;
        }
      }
    });

    localStorage.setItem("cart", JSON.stringify(cart));
    document.getElementById("cart").innerHTML = total;
    updatePopover(cart);
  }

  function clearCart() {
    cart = {};
    localStorage.removeItem("cart");
    updateCart(cart);
  }

  $(".divpr").on("click", "button.cart", function () {
    let id = this.getAttribute("data-id");
    let nameEl = document.getElementById("name" + id);
    let name = nameEl ? nameEl.innerHTML.trim() : "Unknown Product";
    let priceEl = document.getElementById("price" + id);
    let priceText = priceEl ? priceEl.innerHTML.trim() : "0";
    let price = parseFloat(priceText.replace(/Rs\.|₹/g, "")) || 0;

    if (cart[id]) cart[id].qty = cart[id].qty + 1;
    else cart[id] = { qty: 1, name: name, price: price };

    updateCart(cart);
  });

  $(document).on("click", ".plus", function () {
    let id = this.id.replace("plus", "");
    if (cart[id]) cart[id].qty = cart[id].qty + 1;
    updateCart(cart);
  });

  $(document).on("click", ".minus", function () {
    let id = this.id.replace("minus", "");
    if (cart[id] && cart[id].qty > 0) cart[id].qty = cart[id].qty - 1;
    updateCart(cart);
  });

  $(document).on("click", "#clearCartBtn", function () {
    clearCart();
  });

  document.addEventListener("DOMContentLoaded", () => {
    updateCart(cart);
    updatePopover(cart);
  });
</script>
{% endblock %}
